name: stew ci
description: Launch "stew ci" on a python project

inputs:

  project-name:
    description: |
      When empty, all projects in the repository will be targeted.
      When set to '.', the project at the root of the repository will be targeted.
      When set to any other string, only that project will be targeted.
    required: false
    default: ''  # find and run all python projects

  working-directory:
    description: The working directory where stew will run. Defaults to the root of the repository.
    required: false
    default: '.'

  python-version:
    description: The python version number, such as "3.10". See `actions/setup-python` for documentation.
    required: true

  poetry-version:
    description: The pip constraint when installing poetry.
    required: false
    default: ">=2.0.0"

  coveo-stew-version:
    description: The pip constraint when installing coveo-stew.
    required: false
    default: ">=4"

  run-stew:
    description: If not "true", `stew ci` will not be ran. This is a shortcut to checkout/setup-python/poetry/stew without running it.
    required: false
    default: "true"

  install-python:
    description: Can be set to false to skip installing python.
    required: false
    default: "true"


runs:
  using: 'composite'

  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      if: inputs.install-python == 'true'
      with:
        python-version: ${{ inputs.python-version }}

    - name: install poetry and stew
      shell: bash
      env:
        POETRY_VERSION: ${{ inputs.poetry-version }}
        COVEO_STEW_VERSION: ${{ inputs.coveo-stew-version }}

      run: |
        pipx install "poetry$POETRY_VERSION"
        pipx inject poetry "coveo-stew$COVEO_STEW_VERSION"

    - name: Target all projects in the repository
      if: inputs.run-stew == 'true' && inputs.project-name == ''
      shell: bash
      run: echo "Stew will run on all projects in the repository."

    - name: Target specific project by name
      if: inputs.run-stew == 'true' && inputs.project-name != '' && inputs.project-name != '.'
      shell: bash
      env:
        PROJECT_NAME: ${{ inputs.project-name }}
      run: echo "STEW_CI_ARGS=$PROJECT_NAME --exact-match" >> $GITHUB_ENV

    - name: Target the project at the root of the repository
      if: inputs.run-stew == 'true' && inputs.project-name == '.'
      shell: bash
      run: echo "STEW_CI_ARGS=." >> $GITHUB_ENV

    - name: "Run stew ci"
      if: inputs.run-stew == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: poetry stew ci ${{ env.STEW_CI_ARGS }}
